name: Test jsbc.KodiLib

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        kodi-tag: [Matrix, Nexus, Omega]  # Supported tags
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest requests

    - name: Verify Docker is installed
      run: docker --version    

    - name: Prepare Kodi config and run headless Docker
      run: |
        # Install PulseAudio for dummy audio
        sudo apt-get update
        sudo apt-get install -y pulseaudio
        # Start PulseAudio in dummy mode
        pulseaudio --start --exit-idle-time=-1
        export PULSE_SERVER=127.0.0.1

        # Create config directory
        mkdir -p kodi-config/userdata
        
        # guisettings.xml: Enable webserver, disable authentication
        cat << EOF > kodi-config/userdata/guisettings.xml
        <settings version="2">
          <setting id="services.webserver" default="true">true</setting>
          <setting id="services.webserverport" default="true">8080</setting>
          <setting id="services.webserverauthentication" default="true">false</setting>
          <setting id="services.webskin" default="true">webinterface.default</setting>
          <setting id="services.zeroconf" default="true">true</setting>
          <setting id="services.airplay" default="true">false</setting>
          <setting id="services.airplayvolumecontrol" default="true">true</setting>
          <setting id="services.useairplaypassword" default="true">false</setting>
          <setting id="general.addonupdates" default="true">0</setting>
          <setting id="audiooutput.audiodevice">PULSE:Default</setting>
        </settings>
        EOF
        
        # advancedsettings.xml: Log level, headless mode
        cat << EOF > kodi-config/userdata/advancedsettings.xml
        <advancedsettings>
          <loglevel>2</loglevel>
          <video>
            <headless>true</headless>
          </video>
        </advancedsettings>
        EOF
        
        # Pull and run Kodi with noVNC
        docker pull fhriley/kodi-headless-novnc:${{ matrix.kodi-tag }}
        docker run -d --name kodi-headless \
          -p 8080:8080 \
          -p 8000:8000 \
          -p 5900:5900 \
          -p 9090:9090 \
          -p 9777:9777/udp \
          -e PUID=$(id -u) \
          -e PGID=$(id -g) \
          -e TZ=UTC \
          -e KODI_DB_HOST=localhost \
          -e KODI_DB_USER=kodi \
          -e KODI_DB_PASS=kodi \
          -v $(pwd)/kodi-config:/data \
           \
          -e PULSE_SERVER=127.0.0.1 \
          fhriley/kodi-headless-novnc:${{ matrix.kodi-tag }}
        
        # Remove version check add-on
        docker exec kodi-headless rm -rf /usr/share/kodi/addons/service.xbmc.versioncheck || true
        
        # Wait for JSON-RPC
        for attempt in {1..5}; do
          timeout 60 bash -c "until curl -s -f -X POST -H \"Content-Type: application/json\" --data '{\"jsonrpc\":\"2.0\",\"method\":\"JSONRPC.Ping\",\"id\":1}' http://localhost:8080/jsonrpc | grep -q \"pong\"; do
            echo \"Waiting for Kodi to start (attempt $attempt)...\"
            docker logs kodi-headless --tail 20
            sleep 5
          done" && { echo "Kodi is ready!"; break; } || {
            echo "Restarting Kodi container..."
            docker stop kodi-headless || true
            docker rm kodi-headless || true
            docker run -d --name kodi-headless \
              -p 8080:8080 \
              -p 8000:8000 \
              -p 5900:5900 \
              -p 9090:9090 \
              -p 9777:9777/udp \
              -e PUID=$(id -u) \
              -e PGID=$(id -g) \
              -e TZ=UTC \
              -e KODI_DB_HOST=localhost \
              -e KODI_DB_USER=kodi \
              -e KODI_DB_PASS=kodi \
              -v $(pwd)/kodi-config:/data \
               \
              -e PULSE_SERVER=127.0.0.1 \
              fhriley/kodi-headless-novnc:${{ matrix.kodi-tag }}
            docker exec kodi-headless rm -rf /usr/share/kodi/addons/service.xbmc.versioncheck || true
            sleep 5
          }
        done
        
        if ! curl -s -f -X POST -H "Content-Type: application/json" --data '{\"jsonrpc\":\"2.0\",\"method\":\"JSONRPC.Ping\",\"id\":1}' http://localhost:8080/jsonrpc | grep -q "pong"; then
          echo "Kodi failed to start after retries"
          docker logs kodi-headless
          docker exec kodi-headless cat /data/.kodi/temp/kodi.log || true
          exit 1
        fi
        
        # Extra delay
        sleep 30

    - name: Run tests
      run: |
        pytest tests/

    - name: Stop Kodi (cleanup)
      if: always()
      run: |
        docker stop kodi-headless || true
        docker rm kodi-headless || true